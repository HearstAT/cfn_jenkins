---
AWSTemplateFormatVersion: '2010-09-09'
Description: "Xenial (20161214 AMI Build) - Jenkins Master and Docker Build Server"

Parameters:
###############################################################################
# Domain Configuration
###############################################################################
  HostedZone:
    Type: String
    Default: domain.com
    Description: must match a route53 hosted domain/zone

  SSLCertificateARN:
    Type: String
    Default: ''
    Description: SSL Certficate ARN for SSL Certficate

###############################################################################
# Redeploy/Existing Install Configuration
###############################################################################
  ExistingBucketName:
    Type: String
    Default: ''
    Description: Enter a Existing Bucket Name to to use (Leave blank to create new)

  RestoreBackup:
    Type: String
    Default: 'false'
    AllowedValues:
      - 'true'
      - 'false'
    Description: Choose to sync backup from Existing Bucket (Optional)

  AdditionalBucket:
    Type: String
    Default: ''
    Description: Enter a Additional Bucket Name (if you want to use S3 IAM Profile Access for it)

###############################################################################
# Jenkins Configuration
###############################################################################
  JenkinsSubdomain:
    Type: String
    Default: jenkins-test
    AllowedValues:
      - jenkins-a
      - jenkins-b
      - jenkins-test
    Description: subdomain/prefix that is combined with the hosted zone entered

  JenkinsVersion:
    Type: String
    Default: "2.32.1"
    AllowedValues:
      - "2.32.1"
      - "2.19.4"
      - "2.19.3"
      - "2.19.2"
      - "2.19.1"
      - "2.7.4"
      - "2.7.3"
      - "2.7.2"
      - "2.7.1"
    Description: Choose Jenkins Version to Install

  JenkinsLogLevel:
    Type: String
    Default: "INFO"
    AllowedValues:
      - "SEVERE"
      - "WARNING"
      - "INFO"
      - "CONFIG"
      - "FINE"
      - "FINER"
      - "FINEST"
      - "ALL"
    Description: Choose log level for Jenkins Master

  MasterInstanceType:
    Type: String
    Default: t2.micro
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
    ConstraintDescription: must be a valid EC2 instance type.

  JJBRepo:
    Type: String
    Default: ''
    Description: Enter Repo Clone URL for Jenkins Job Builder Templates

###############################################################################
# Github Configuration
###############################################################################
  GitEmail:
    Type: String
    Default: ''
    Description: Enter Github Commit Email

  GithubOrg:
    Type: String
    Default: ''
    Description: Enter Github Organization (Auth Org)

  GithubAdmins:
    Type: String
    Default: ''
    Description: Enter Github Users that will be Jenkins Admins

  GithubClientID:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: Enter Github oauth ClientID

  GithubClientSecret:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: Enter Github oauth ClientSecret

  GithubCreds:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: Enter you Github Username and Personal Access Token in this format `ghuser:token`

###############################################################################
# Slack Configuration
###############################################################################
  SlackTeam:
    Type: String
    Default: ''
    Description: Enter Slack Team

  SlackRoom:
    Type: String
    Default: ''
    Description: Enter Default Slack Room/Channel for Job Post (ID Recommended)

  SlackToken:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: Enter Slack Token

###############################################################################
# Plugins Configuration
###############################################################################
  AdminEmail:
    Type: String
    Default: ''
    Description: Enter Email Address for Jenkins to send emails as

  MailUser:
    Type: String
    Default: ''
    Description: Enter SMTP Service User

  MailPassword:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: Enter SMTP Service User

  MailHost:
    Type: String
    Default: ''
    Description: Enter SMTP Host (e.g.; smtp.mailgun.org)

  MailPort:
    Type: String
    Default: ''
    Description: Enter SMTP Host

###############################################################################
# Jenkins Build Host Configuration
###############################################################################
  DockerVersion:
    Type: String
    Default: "1.12.5"
    AllowedValues:
      - "1.12.5"
      - "1.12.4"
      - "1.12.3"
      - "1.12.2"
      - "1.12.1"
      - "1.12.0"
      - "1.11.2"
      - "1.11.1"
      - "1.11.0"
    Description: Choose Docker Version to Install

  BuildInstanceType:
    Type: String
    Default: t2.small
    AllowedValues:
      - t2.nano
      - t2.micro
      - t2.small
      - t2.medium
      - t2.large
    ConstraintDescription: must be a valid EC2 instance type.

###############################################################################
# Instance and Network Configuration
###############################################################################
  VPC:
    Description: Choose VPC to use
    Type: AWS::EC2::VPC::Id
    Default: ''

  KeyName:
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instance
    Type: AWS::EC2::KeyPair::KeyName

  SSHSecurityGroup:
    Description: Select Security Group for SSH Access
    Type: AWS::EC2::SecurityGroup::Id
    Default: ''

  CIDRA:
    Type: String
    Default: 172.33.40.0/24
    Description: Subnet A CIDR Block

###############################################################################
# Sumologic Configuration
###############################################################################
  SumologicAccessID:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: (Optional) Enter Sumologic Access ID

  SumologicAccessKey:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: (Optional) Enter Sumologic Access Key

###############################################################################
# New Relic Configuration
###############################################################################
  NewRelicAppName:
    Type: String
    Default: ''
    Description: (Optional) Enter New Relic Application Name; e.g.; jenkins_stack

  NewRelicLicense:
    Type: String
    NoEcho: 'true'
    Default: ''
    Description: (Optional) Enter New Relic License Key

###############################################################################
# Development Configuration
###############################################################################
  GitClone:
    Description: Enter Git Clone URL for Scripts
    Type: String
    Default: 'https://github.com/HearstAT/cfn_jenkins.git'
  GitBranch:
    Description: Enter Branch to Pull Scripts From (For Testing Only Leave Default for Prod)
    Type: String
    Default: 'master'

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
    -
      Label:
        default: Domain Configuration
      Parameters:
        - HostedZone
        - SSLCertificateARN
    -
      Label:
        default: Redeploy/Existing Install Configuration
      Parameters:
        - ExistingBucketName
        - RestoreBackup
        - AdditionalBucket
    -
      Label:
        default: Jenkins Configuration
      Parameters:
        - MasterInstanceType
        - JenkinsSubdomain
        - JenkinsVersion
        - JenkinsLogLevel
        - JJBRepo
    -
      Label:
        default: Github Configuration
      Parameters:
        - GithubAdmins
        - GithubCreds
        - GithubOrg
        - GitEmail
        - GithubClientID
        - GithubClientSecret

    -
      Label:
        default: Slack Configuration
      Parameters:
        - SlackTeam
        - SlackRoom
        - SlackToken
    -
      Label:
        default: Mail Configuration
      Parameters:
        - AdminEmail
        - MailUser
        - MailPassword
        - MailHost
        - MailPort
    -
      Label:
        default: Jenkins Build Host Configuration
      Parameters:
        - BuildInstanceType
        - DockerVersion
    -
      Label:
        default: Network Configuration
      Parameters:
        - KeyName
        - VPC
        - SSHSecurityGroup
        - CIDRA
    -
      Label:
        default: Sumologic Configuration
      Parameters:
        - SumologicAccessID
        - SumologicAccessKey
    -
      Label:
        default: New Relic Configuration
      Parameters:
        - NewRelicAppName
        - NewRelicLicense
    -
      Label:
        default: Development Options
      Parameters:
        - GitClone
        - GitBranch

Conditions:
  # Creates bucket if no existing name entered
  JenkinsBucketCon:
    !Equals [ !Ref ExistingBucketName, '' ]
  AdditionalBucketCon:
    !Not [ !Equals [ !Ref AdditionalBucket, '' ] ]

Mappings:
  RegionMap:
    us-west-2:
      HVM64: ami-b7a114d7
    eu-west-1:
      HVM64: ami-6f587e1c

Resources:
###############################################################################
# Subnets
###############################################################################
  SubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      # Get Availability Zones and select first in string
      AvailabilityZone: !Select [ 0, !GetAZs "" ]
      CidrBlock: !Ref CIDRA
      Tags:
        - Key: Name
          Value: Public-Subnet-A
        - Key: Application
          Value: !Ref AWS::StackId
        - Key: Network
          Value: "Public"

###############################################################################
# S3 Buckets
###############################################################################
  JenkinsBucket:
    Type: AWS::S3::Bucket
    Condition: JenkinsBucketCon
    DeletionPolicy: Retain
    Properties:
      AccessControl: Private

###############################################################################
# EIP
###############################################################################
  MasterEIP:
    Type: "AWS::EC2::EIP"
    Properties:
      Domain: VPC

###############################################################################
# Security: IAM, Groups, Instance Profiles
###############################################################################
  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
        - !Ref InstanceRole
  InstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          -
            Effect: "Allow"
            Principal:
              Service:
                - "ec2.amazonaws.com"
            Action:
              - "sts:AssumeRole"
      Path: "/"

  RolePolicies:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: !Sub ${AWS::StackName}-JenkinsServer-Policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow all actions to one bucket (the supplied one, or the one you provided)
          - Action: s3:*
            Effect: Allow
            Resource:
              - !Join ['', [ 'arn:aws:s3:::', !If [JenkinsBucketCon, !Ref JenkinsBucket, !Ref ExistingBucketName] ]]
              - !Join ['', [ 'arn:aws:s3:::', !If [JenkinsBucketCon, !Ref JenkinsBucket, !Ref ExistingBucketName], '/*' ]]
          # Allow ability to list all buckets
          - Action: s3:List*
            Effect: Allow
            Resource: arn:aws:s3:::*
          # Allow instances to read their own tags (needed for setup script below)
          - Action: ec2:DescribeTags
            Effect: Allow
            Resource: "*"
      Roles:
        - !Ref InstanceRole

  AdditionalBucketPolicies:
    Type: AWS::IAM::Policy
    Condition: AdditionalBucketCon
    Properties:
      PolicyName: !Sub ${AWS::StackName}-JenkinsServer-AdditionalBuckets-Policy
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          # Allow all actions to one bucket (the supplied one, or the one you provided)
          - Action: s3:*
            Effect: Allow
            Resource:
              - !Sub arn:aws:s3:::${AdditionalBucket}
              - !Sub arn:aws:s3:::${AdditionalBucket}/*
      Roles:
        - !Ref InstanceRole

  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Setup Ingress/Egress for Jenkins ELB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '443'
          ToPort: '443'
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: '0'
          ToPort: '65535'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: !Sub ${JenkinsSubdomain}-ELB-SecurityGroup

  MasterSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Setup Ingress/Egress for Servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '8080'
          ToPort: '8080'
          SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
        - IpProtocol: tcp
          FromPort: '0'
          ToPort: '65535'
          SourceSecurityGroupId: !Ref BuildSecurityGroup
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          SourceSecurityGroupId: !Ref SSHSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: '0'
          ToPort: '65535'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: Jenkins-Master-Security-Group

  BuildSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Setup Ingress/Egress for Servers
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: '0'
          ToPort: '65535'
          CidrIp: !Ref CIDRA
        - IpProtocol: tcp
          FromPort: '22'
          ToPort: '22'
          SourceSecurityGroupId: !Ref SSHSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: tcp
          FromPort: '0'
          ToPort: '65535'
          CidrIp: 0.0.0.0/0
      Tags:
        - Key: Name
          Value: Jenkins-Build-Security-Group

###############################################################################
# Load Balancer (For SSL) and DNS
###############################################################################
  ElasticLoadBalancer:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      HealthCheck:
        HealthyThreshold: '2'
        Interval: '90'
        Target: HTTP:8080/login
        Timeout: '60'
        UnhealthyThreshold: '10'
      Instances:
        - !Ref MasterInstance
      Subnets:
        - !Ref SubnetA
      SecurityGroups:
        - !Ref LoadBalancerSecurityGroup
      LBCookieStickinessPolicy:
        - PolicyName: PublicELBCookieStickinessPolicy
          CookieExpirationPeriod: '3600'
      Listeners:
        - InstancePort: '8080'
          LoadBalancerPort: '443'
          InstanceProtocol: HTTP
          Protocol: HTTPS
          PolicyNames:
            - PublicELBCookieStickinessPolicy
          SSLCertificateId: !Ref SSLCertificateARN
      Tags:
        - Key: Name
          Value: !Sub ${JenkinsSubdomain}-ELB

  JenkinsDNS:
    Type: AWS::Route53::RecordSetGroup
    Properties:
      HostedZoneName: !Sub "${HostedZone}."
      Comment: !Sub Zone apex alias targeted to ${JenkinsSubdomain} ELB.
      RecordSets:
        - Name: !Sub "${JenkinsSubdomain}.${HostedZone}."
          Type: A
          AliasTarget:
            HostedZoneId: !GetAtt ElasticLoadBalancer.CanonicalHostedZoneNameID
            DNSName: !GetAtt ElasticLoadBalancer.CanonicalHostedZoneName

###############################################################################
# Jenkins Master
###############################################################################
  MasterInstance:
    Type: AWS::EC2::Instance
    DependsOn:
      - BuildInstance
    Properties:
      ImageId: !FindInMap [ RegionMap, !Ref "AWS::Region", HVM64 ]
      InstanceType: !Ref MasterInstanceType
      KeyName: !Ref KeyName
      NetworkInterfaces:
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet:
            - !Ref MasterSecurityGroup
            - !Ref SSHSecurityGroup
          SubnetId:
            Ref: SubnetA
      BlockDeviceMappings:
        - DeviceName: "/dev/sda1"
          Ebs:
            VolumeSize: '15'
      IamInstanceProfile: !Ref InstanceProfile
      UserData:
        "Fn::Base64":
          "Fn::Sub":
            - |
              #!/bin/bash -xev

              ##########################################################
              # Upgrade OS & Install Dependencies
              ##########################################################

              apt-get update && apt-get -y upgrade
              apt-get install -y wget curl python-setuptools python-pip git apt-transport-https

              ##########################################################
              # Global Variable Set
              ##########################################################

              export DEBIAN_FRONTEND=noninteractive
              export INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
              export STACKNAME='${AWS::StackName}'
              export HOSTNAME="${JenkinsSubdomain}.${HostedZone}"
              export GITCLONE='${GitClone}'
              export GITREPO="${!GITCLONE##*/}"
              export JJBREPO='${JJBRepo}'
              export JJBREPONAME="${!JJBREPO##*/}"
              export JJBTOKEN=$(openssl rand -hex 16)
              export GHCREDS='${GithubCreds}'

              ##########################################################
              # Install cfn bootstraping tools
              ##########################################################

              if [ -z $(command -v cfn-signal) ]; then
                  easy_install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz
              fi

              if [ -z $(command -v aws) ]; then
                sleep 5
                pip install awscli
              fi

              ##########################################################
              # Helper function to set wait timer
              ##########################################################

              error_exit()
              {
                cfn-signal -e 1 -r "$1" "${MasterWaitHandle}"
                exit 1
              }

              export -f error_exit

              ##########################################################
              # Set Hostname and Hosts File
              ##########################################################

              hostname ${!HOSTNAME} || error_exit 'Failed to set hostname'
              echo "${!HOSTNAME}" > /etc/hostname || error_exit 'Failed to set hostname file'

              cat > '/etc/hosts' << EOF
              127.0.0.1 ${!HOSTNAME} ${!HOSTNAME%%.*} jenkins.${!HOSTNAME%%.*} localhost
              ::1 localhost6.localdomain6 localhost6
              EOF

              ##########################################################
              # Jenkins User Add
              ##########################################################

              if [ -z $(getent passwd jenkins) ]; then
                useradd -d "/var/lib/jenkins" -m -s /bin/bash jenkins || error_exit "Failed to create Jenkins User"
              fi

              ##########################################################
              # Add Jenkins Repo & Install
              ##########################################################

              ## Dependencies
              apt-get install -y ca-certificates-java daemon dbus default-jre-headless \
              fontconfig-config fonts-dejavu-core java-common libavahi-client3 libxi6 \
              libavahi-common-data libavahi-common3 libcap-ng0 libcups2 libdbus-1-3 libexpat1 \
              libfontconfig1 libfreetype6 libjpeg-turbo8 libjpeg8 liblcms2-2 libnspr4 libnss3 \
              libnss3-nssdb libpcsclite1 libpng12-0 libx11-6 libx11-data libxau6 libxcb1 libxdmcp6 libxext6 \
              libxrender1 libxtst6 net-tools openjdk-8-jre-headless psmisc ucf x11-common || error_exit "Jenkins Install: Failed to install dependencies"

              ## User war download to control version
              mkdir -p /var/run/jenkins/ /var/lib/jenkins /usr/share/jenkins /var/log/jenkins || error_exit "Jenkins Install: Failed to create Jenkins directories"
              wget "http://mirrors.jenkins.io/war-stable/${JenkinsVersion}/jenkins.war" -qO /usr/share/jenkins/jenkins.war || error_exit "Jenkins Install: Failed to download Jenkins war"
              chmod -R 755 /var/run/jenkins/ /var/lib/jenkins /usr/share/jenkins /var/log/jenkins || error_exit "Jenkins Install: Failed to change Jenkins directory mode"
              chown -R jenkins:jenkins /var/run/jenkins/ /var/lib/jenkins /usr/share/jenkins /var/log/jenkins || error_exit "Jenkins Install: Failed to change Jenkins directory owner"

              ##########################################################
              # Jenkins Log & Service Configuration
              ##########################################################

              ## Systemd Service File
              cat > '/lib/systemd/system/jenkins.service' << 'EOF'
              [Unit]
              Description=jenkins
              After=network.target

              [Service]
              Type=simple
              User=jenkins
              Group=jenkins
              Environment=JENKINS_HOME=/var/lib/jenkins
              ExecStartPre=/bin/rm -f /var/run/jenkins/jenkins.pid
              ExecStart=/usr/bin/java -Djava.awt.headless=true -jar /usr/share/jenkins/jenkins.war --httpPort=8080 --httpListenAddress=0.0.0.0
              ExecReload=/bin/kill -s HUP $MAINPID
              TimeoutStartSec=0
              Restart=always
              RestartSec=20
              Delegate=yes
              KillMode=process

              [Install]
              WantedBy=multi-user.target
              EOF

              systemctl enable jenkins || error_exit "Jenkins Install: Failed to enable Jenkins"

              ##########################################################
              # Clone Script Repo
              ##########################################################

              if [ ! -d "/root/${!GITREPO%.*}" ]; then
                cd /root && git clone ${!GITCLONE} || error_exit "Get Groovy Scripts: Failed to Clone Scripts from Repo"
              else
                cd /root/${!GITREPO%.*} && git pull || error_exit "Get Groovy Scripts: Failed pull updates"
              fi

              if [ '${GitBranch}' != 'master' ]; then
                cd /root/${!GITREPO%.*} && git checkout ${GitBranch} || error_exit "Get Groovy Scripts: Failed to switch to ${GitBranch} branch"
              fi

              ##########################################################
              # Jenkins Sync & Bootstrap
              ##########################################################

              ## Swap Placeholders with Params
              ### Github Oauth Config Script
              sed -i 's/replaceClientID/${GithubClientID}/g' /root/${!GITREPO%.*}/scripts/bootstrap/github_auth.groovy || error_exit "Groovy Bootstrap: Failed to replace Github Oath Params"
              sed -i 's/replaceClientSecret/${GithubClientSecret}/g' /root/${!GITREPO%.*}/scripts/bootstrap/github_auth.groovy || error_exit "Groovy Bootstrap: Failed to replace Github Oath Params"
              sed -i 's/replaceGithubOrg/${GithubOrg}/g' /root/${!GITREPO%.*}/scripts/bootstrap/github_auth.groovy || error_exit "Groovy Bootstrap: Failed to replace Github Oath Params"
              sed -i 's/replaceGithubAdmins/${GithubAdmins}/g' /root/${!GITREPO%.*}/scripts/bootstrap/github_auth.groovy || error_exit "Groovy Bootstrap: Failed to replace Github Oath Params"
              ### Github Server Config (Pending)
              ### Credentials Config Script
              sed -i 's/replaceSlackToken/${SlackToken}/g' /root/${!GITREPO%.*}/scripts/bootstrap/credentials.groovy || error_exit "Groovy Bootstrap: Failed to replace Slack Credential Params"
              sed -i 's/replaceGitToken/${!GHCREDS##*:}/g' /root/${!GITREPO%.*}/scripts/bootstrap/credentials.groovy || error_exit "Groovy Bootstrap: Failed to replace Github Credential Params"
              ### Git Config Script
              sed -i 's/replaceGitEmail/${GitEmail}/g' /root/${!GITREPO%.*}/scripts/bootstrap/git.groovy || error_exit "Groovy Bootstrap: Failed to replace Git Params"
              ### Slack Config Script
              sed -i 's/replaceSlackTeam/${SlackTeam}/g' /root/${!GITREPO%.*}/scripts/bootstrap/slack.groovy || error_exit "Groovy Bootstrap: Failed to replace Slack Params"
              sed -i 's/replaceSlackRoom/${SlackRoom}/g' /root/${!GITREPO%.*}/scripts/bootstrap/slack.groovy || error_exit "Groovy Bootstrap: Failed to replace Slack Params"
              ### Docker Config Script
              sed -i 's/replaceDockerIP/${DOCKERIP}/g' /root/${!GITREPO%.*}/scripts/bootstrap/docker.groovy || error_exit "Groovy Bootstrap: Failed to replace Docker Params"
              ### Mail Config
              sed -i 's/replaceAdminEmail/${AdminEmail}/g' /root/${!GITREPO%.*}/scripts/bootstrap/mail.groovy || error_exit "Groovy Bootstrap: Failed to replace Mail Params"
              sed -i 's/replaceMailUser/${MailUser}/g' /root/${!GITREPO%.*}/scripts/bootstrap/mail.groovy || error_exit "Groovy Bootstrap: Failed to replace Mail Params"
              sed -i 's/replaceMailPassword/${MailPassword}/g' /root/${!GITREPO%.*}/scripts/bootstrap/mail.groovy || error_exit "Groovy Bootstrap: Failed to replace Mail Params"
              sed -i 's/replaceMailHost/${MailHost}/g' /root/${!GITREPO%.*}/scripts/bootstrap/mail.groovy || error_exit "Groovy Bootstrap: Failed to replace Mail Params"
              sed -i 's/replaceMailPort/${MailPort}/g' /root/${!GITREPO%.*}/scripts/bootstrap/mail.groovy || error_exit "Groovy Bootstrap: Failed to replace Mail Params"
              ### JJB Job Config
              sed -i 's/replaceJJBJobs/${JJBRepo}/g' /root/${!GITREPO%.*}/scripts/jobs/jjb_seed/jjb_seed.xml || error_exit "Groovy Bootstrap: Failed to replace JJB Job Repo URL"
              sed -i 's/replaceRepoName/${!JJBREPONAME%.*}/g' /root/${!GITREPO%.*}/scripts/jobs/jjb_seed/jjb_seed.xml || error_exit "Groovy Bootstrap: Failed to replace JJB Job Repo Name"
              sed -i 's/replaceServerURL/${HostedZone}/g' /root/${!GITREPO%.*}/scripts/jobs/jjb_seed/jjb_seed.xml || error_exit "Groovy Bootstrap: Failed to replace JJB Job Repo Build URL"
              sed -i 's/replaceToken/${!JJBTOKEN}/g' /root/${!GITREPO%.*}/scripts/jobs/jjb_seed/jjb_seed.xml || error_exit "Groovy Bootstrap: Failed to replace JJB Job Repo External Token"

              systemctl start jenkins || error_exit "Jenkins Bootstrap: Failed to start Jenkins"

              until $(curl --output /dev/null --silent --head --fail 127.0.0.1:8080/login); do
                printf '.'
                sleep 5
              done

              ADMINCREDS="admin:$(cat /var/lib/jenkins/secrets/initialAdminPassword)"

              systemctl restart jenkins || error_exit "Jenkins Bootstrap: Failed to restart Jenkins"

              until $(curl --output /dev/null --silent --head --fail 127.0.0.1:8080/login); do
                printf '.'
                sleep 5
              done

              crumb=`curl --user "${!ADMINCREDS}" "127.0.0.1:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,%22:%22,//crumb)"`
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/plugins.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Plugins Install"
              ## Pull In Backup Data
              if [ -n ${ExistingBucketName} ] && [ ${RestoreBackup} == 'true' ]; then
                aws s3 sync s3://${ExistingBucketName}/jenkins /var/lib/jenkins || error_exit "Jenkins Sync: Failed to sync existing data"
                chmod -R 755 /var/run/jenkins/ /var/lib/jenkins /usr/share/enkins /var/log/jenkins || error_exit "Jenkins Install: Failed to change Jenkins directory mode"
                chown -R jenkins:jenkins /var/run/jenkins/ /var/lib/jenkins /usr/share/jenkins /var/log/jenkins || error_exit "Jenkins Install: Failed to change Jenkins directory owner"
                if [ -n '${GithubCreds}' ]; then
                  unset $ADMINCREDS
                  ADMINCREDS='${GithubCreds}'
                fi
              fi

              until $(curl --output /dev/null --silent --head --fail 127.0.0.1:8080/login); do
                printf '.'
                sleep 5
              done

              crumb=`curl --user "${!ADMINCREDS}"  "127.0.0.1:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,%22:%22,//crumb)"`

              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/buildPort.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Build Port Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/executors.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Executors Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/security.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Security Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/mail.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Mail Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/credentials.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Credentials Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/slack.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Plugin Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/git.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Plugin Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/docker.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Plugin Config"
              curl -H $crumb --user "${!ADMINCREDS}" --data-urlencode "script=$(</root/${!GITREPO%.*}/scripts/bootstrap/github_auth.groovy)" 127.0.0.1:8080/scriptText || error_exit "Jenkins Bootstrap: Failed to run Groovy Github Oauth Config"
              systemctl stop jenkins || error_exit "Failed to stop Jenkins"

              cat > '/var/lib/jenkins/jenkins.install.InstallUtil.lastExecVersion' << EOF
              ${JenkinsVersion}
              EOF

              cat > '/var/lib/jenkins/jenkins.install.UpgradeWizard.state' << EOF
              ${JenkinsVersion}
              EOF

              aws s3 sync /var/lib/jenkins/ s3://${BUCKET}/jenkins --exclude "*" --exclude "*/*" --exclude ".jenkins" --include "*.xml" --include "*.key" --include "secrets/*" || error_exit "Jenkins Sync: Failed to sync new data"

              mkdir -p /var/lib/jenkins/data || error_exit "Jenkins Bootstrap: Failed to create Jenkins data directory"

              cat > '/var/lib/jenkins/data/log.properties' << EOF
              handlers=java.util.logging.ConsoleHandler
              jenkins.level=${JenkinsLogLevel}
              java.util.logging.ConsoleHandler.level=${JenkinsLogLevel}
              EOF

              cp -f /root/${!GITREPO%.*}/scripts/xml/* /var/lib/jenkins/ || error_exit "Jenkins Bootstrap: Failed to Copy XML files in place"
              cp -rf /root/${!GITREPO%.*}/scripts/jobs /var/lib/jenkins/ || error_exit "Jenkins Bootstrap: Failed to Copy JJB Seed/Sync job"

              chmod -R 755 /var/lib/jenkins || error_exit "Jenkins Bootstrap: Failed to change Jenkins directory mode"
              chown -R jenkins:jenkins /var/lib/jenkins || error_exit "Jenkins Bootstrap: Failed to change Jenkins directory owner"

              systemctl start jenkins || error_exit "Jenkins Bootstrap: Failed to start Jenkins"

              ##########################################################
              # Run JJB Seed
              ##########################################################

              # until $(curl --output /dev/null --silent --head --fail 127.0.0.1:8080/login); do
              #   printf '.'
              #   sleep 5
              # done
              #
              # https://${JenkinsSubdomain}.${HostedZone}/job/jjb-sync/build?token=${!JJBTOKEN}

              ##########################################################
              # NewRelic Config if Enabled
              ##########################################################

              if [ -n "${NewRelicLicense}" ]; then
                bash /root/${!GITREPO%.*}/scripts/bootstrap/newrelic.sh ${NewRelicLicense} ${NewRelicAppName}
              fi

              ##########################################################
              # Sumologic Config if Enabled
              ##########################################################

              if [ -n "${SumologicAccessID}" ]; then
                bash /root/${!GITREPO%.*}/scripts/bootstrap/sumologic.sh master ${SumologicAccessID} ${SumologicAccessKey}
              fi

              ##########################################################
              # Send Success Signal to CFN Wait Handle
              ##########################################################

              /usr/local/bin/cfn-signal -e 0 -r 'Server setup complete' "${MasterWaitHandle}"

              ##########################################################
              # Reboot After Success for all updates made
              ##########################################################

              apt-get update && apt-get -y upgrade
              reboot

            - { BUCKET: !If [ JenkinsBucketCon, !Ref JenkinsBucket, !Ref ExistingBucketName ], DOCKERIP: !GetAtt BuildInstance.PrivateIp }

      Tags:
        - Key: Name
          Value: !Sub Jenkins-Master-${AWS::StackName}

  MasterEIPAssign:
    Type: "AWS::EC2::EIPAssociation"
    Properties:
      EIP: !Ref MasterEIP
      InstanceId: !Ref MasterInstance

###############################################################################
# Jenkins Build/Docker Host
###############################################################################
  BuildInstance:
    Type: AWS::EC2::Instance
    Properties:
      ImageId: !FindInMap [ RegionMap, !Ref "AWS::Region", HVM64 ]
      InstanceType: !Ref BuildInstanceType
      KeyName: !Ref KeyName
      NetworkInterfaces:
        - AssociatePublicIpAddress: "true"
          DeviceIndex: "0"
          GroupSet:
            - !Ref BuildSecurityGroup
            - !Ref SSHSecurityGroup
          SubnetId:
            Ref: SubnetA
      BlockDeviceMappings:
        - DeviceName: "/dev/sda1"
          Ebs:
            VolumeSize: '15'
      IamInstanceProfile: !Ref InstanceProfile
      UserData:
        "Fn::Base64":
          "Fn::Sub": |
            #!/bin/bash -xev

            ##########################################################
            # Upgrade OS & Install Dependencies
            ##########################################################

            apt-get update && apt-get -y upgrade
            apt-get install -y wget curl python-setuptools python-pip git

            ##########################################################
            # Global Variable Set
            ##########################################################

            export DEBIAN_FRONTEND=noninteractive
            export INSTANCE_ID=$(curl -s http://169.254.169.254/latest/meta-data/instance-id)
            export STACKNAME='${AWS::StackName}'
            export HOSTNAME="${JenkinsSubdomain}-build-${!INSTANCE_ID}.${HostedZone}"
            export GHCREDS='${GithubCreds}'

            ##########################################################
            # Install cfn bootstraping tools
            ##########################################################

            if [ -z $(command -v cfn-signal) ]; then
                easy_install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz
            fi

            ##########################################################
            # Helper function to set wait timer
            ##########################################################

            error_exit()
            {
              cfn-signal -e 1 -r "$1" "${BuildWaitHandle}"
              exit 1
            }

            export -f error_exit

            ##########################################################
            # Set Hostname and Hosts File
            ##########################################################

            hostname ${!HOSTNAME} || error_exit 'Failed to set hostname'
            echo "${!HOSTNAME}" > /etc/hostname || error_exit 'Failed to set hostname file'

            cat > '/etc/hosts' << EOF
            127.0.0.1 ${!HOSTNAME} ${!HOSTNAME%%.*} localhost
            ::1 localhost6.localdomain6 localhost6
            EOF

            ##########################################################
            # Add Docker Repo & Install
            ##########################################################

            apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D || error_exit "Failed to add APT Repo Key"
            apt-add-repository 'deb https://apt.dockerproject.org/repo ubuntu-xenial main' || error_exit "Failed to add Repo List"

            apt-get update && apt-get install -y docker-engine=${DockerVersion}-0* || error_exit "Failed to Install Docker Engine"

            ##########################################################
            # Docker Setup
            ##########################################################

            cat > '/lib/systemd/system/docker.service' << 'EOF'
            [Unit]
            Description=Docker Application Container Engine
            Documentation=https://docs.docker.com
            After=network.target docker.socket
            Requires=docker.socket

            [Service]
            Type=notify
            Environment=DOCKER_CONTENT_TRUST=0
            ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:9800 -H unix:///var/run/docker.sock --pidfile=/var/run/docker.pid
            ExecReload=/bin/kill -s HUP $MAINPID
            LimitNOFILE=infinity
            LimitNPROC=infinity
            LimitCORE=infinity
            TasksMax=infinity
            TimeoutStartSec=0
            Delegate=yes
            KillMode=process

            [Install]
            WantedBy=multi-user.target
            EOF

            systemctl daemon-reload || error_exit "Failed to reload Docker Daemon Changes"
            systemctl restart docker || error_exit "Failed to restart Docker Daemon"

            ##########################################################
            # Docker Get Base Images
            ##########################################################

            docker pull hearstat/jenkins-build-base:debian || error_exit "Failed to pull Base Image: Debian"
            docker pull hearstat/jenkins-build-base:alpine || error_exit "Failed to pull Base Image: Alpine"
            docker pull hearstat/jenkins-build-foodcritic || error_exit "Failed to pull Image: Foodcritic"

            ##########################################################
            # Jenkins Job Builder Config
            ##########################################################

            mkdir -p /etc/jenkins_jobs || error_exit "JJB: Failed to Create Directory"

            cat > '/etc/jenkins_jobs/jenkins_jobs.ini' << EOF
            [job_builder]
            ignore_cache=True
            keep_descriptions=False
            recursive=True
            allow_duplicates=False

            [jenkins]
            user=${!GHCREDS%:*}
            password=${!GHCREDS##*:}
            url=https://${JenkinsSubdomain}.${HostedZone}
            EOF

            chmod -R 777 /etc/jenkins_jobs || error_exit "JJB: Failed to chmod Directory and Files"

            ##########################################################
            # NewRelic Config if Enabled
            ##########################################################

            if [ -n "${NewRelicLicense}" ]; then
              wget -qO /root/newrelic.sh 'https://github.com/HearstAT/cfn_jenkins/raw/${GitBranch}/newrelic.sh' && bash /root/newrelic.sh ${NewRelicLicense} ${NewRelicAppName}
            fi

            ##########################################################
            # Sumologic Config if Enabled
            ##########################################################

            if [ -n "${SumologicAccessID}" ]; then
              wget -qO /root/sumologic.sh 'https://github.com/HearstAT/cfn_jenkins/raw/${GitBranch}/sumologic.sh' && bash /root/sumologic.sh proxy ${SumologicAccessID} ${SumologicAccessKey}
            fi

            ##########################################################
            # Send Success Signal to CFN Wait Handle
            ##########################################################

            /usr/local/bin/cfn-signal -e 0 -r 'Server setup complete' "${BuildWaitHandle}"

            ##########################################################
            # Reboot After Success for all updates made
            ##########################################################

            apt-get update && apt-get -y upgrade
            reboot

      Tags:
        - Key: Name
          Value: !Sub Jenkins-Build-Server-${AWS::StackName}

  MasterWaitHandle:
    Type: AWS::CloudFormation::WaitConditionHandle
  MasterWaitCondition:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: MasterInstance
    Properties:
      Handle:  !Ref MasterWaitHandle
      Timeout: '900'

  BuildWaitHandle:
    Type: AWS::CloudFormation::WaitConditionHandle
  BuildWaitCondition:
    Type: AWS::CloudFormation::WaitCondition
    DependsOn: BuildInstance
    Properties:
      Handle:  !Ref BuildWaitHandle
      Timeout: '900'
